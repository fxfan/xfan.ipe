/*! jquery.xfan.ipe - v0.9.5 - 2012-12-30
* https://github.com/fxfan/xfan.ipe
* Copyright (c) 2012 xfan; Licensed MIT */
var xfan={ipe:{defaultOptions:{formType:"text",editEvent:"click",editableMarkText:"edit",saveButtonCaption:"save",cancelButtonCaption:"cancel",savingMessage:"saving...",placeholder:"(please input)",editableClass:"xfanIpeEditable",editableMouseoverClass:"xfanIpeEditableMouseover",editableLabelClass:"xfanIpeEditableLabel",editableMarkClass:"xfanIpeEditableMark",ipeClass:"xfanIpe",saveButtonClass:"xfanIpeSaveButton",cancelButtonClass:"xfanIpeCancelButton",savingMessageClass:"xfanIpeSavingMessage",errorMessageClass:"xfanIpeErrorMessage"},Editable:function(e,t){this._init(e,t)},AbstractIpe:function(e,t){this._init(e,t)},register:function(e,t){var n=xfan.ipe.editors[e]=function(e,t){this._init(e,t)};$.extend(n.prototype,xfan.ipe.AbstractIpe.prototype,t)},editors:{}}};(function(e){var t=function(e,t){var n=function(e,n){return typeof t[n]=="string"||typeof t[n]=="number"?t[n]:e};return e.replace(/#\{([^{}]*)}/g,n)},n=function(t){return e("<div>").text(t).html()};e.extend(xfan.ipe.Editable.prototype,{_init:function(n,r){this.opts=r,n&&(this.id="xfanIpeEditable-"+n),this.dom=e("<div></div>").attr("id",this.id).addClass(r.editableClass).bind("mouseenter",function(){e(this).addClass(r.editableMouseoverClass)}).bind("mouseleave",function(){e(this).removeClass(r.editableMouseoverClass)});var i=r.labelTag||"span";this.editableLabel=e("<"+i+"></"+i+">").addClass(r.editableLabelClass).appendTo(this.dom),this.editableMark=e(t("<span>#{t}</span>",{t:r.editableMarkText})).addClass(r.editableMarkClass).appendTo(this.dom)},label:function(e){return this.editableLabel.html(e)},hide:function(e,t){this.dom.fadeOut(e,t)},show:function(e,t){this.dom.fadeIn(e,t)},addEditEventListener:function(t,n){var r=this.opts.editableMouseoverClass;this.dom.bind(t,function(){e(this).removeClass(r),n.apply(this)})}}),e.extend(xfan.ipe.AbstractIpe.prototype,{_init:function(t,n){this.opts=n,t&&(this.id="xfanIpe-"+t),this.dom=e("<div></div>").attr("id",this.id).addClass(n.ipeClass).hide(),this.input=this.createInput(),this.savingMessage=this.createSavingMessage(),this.saveButton=this.createSaveButton(),this.cancelButton=this.createCancelButton(),this.errorMessage=this.createErrorMessage(),this.dom.append(this.input).append(this.savingMessage).append(this.saveButton).append(this.cancelButton).append(this.errorMessage),this.init(),n.init&&this.val(n.init)},init:function(){},createInput:function(){return e("<span>need to override createInput() method.</span>")},createSaveButton:function(){return e(t('<input type="button" value="#{v}" />',{v:this.opts.saveButtonCaption})).addClass(this.opts.saveButtonClass)},createCancelButton:function(){return e(t('<input type="button" value="#{v}" />',{v:this.opts.cancelButtonCaption})).addClass(this.opts.cancelButtonClass)},createSavingMessage:function(){return e(t("<span>#{v}</span>",{v:this.opts.savingMessage})).addClass(this.opts.savingMessageClass)},createErrorMessage:function(){return e("<span></span>").addClass(this.opts.errorMessageClass)},show:function(e,t){this.dom.fadeIn(e,t)},hide:function(e,t){this.dom.fadeOut(e,t)},activate:function(e){this.oldValue=this.val(),this.editingMode(),this.show("fast",e)},passivate:function(e){this.hide("fast",e)},discard:function(e){this.onFinishEditing(),this.val(this.oldVal()),this.passivate(e)},savingMode:function(e){this.onFinishEditing(),this.saveButton.attr("disabled",!0),this.cancelButton.attr("disabled",!0),this.input.hide(),this.savingMessage.show(),e&&e()},editingMode:function(){this.errorMessage.hide(),this.savingMessage.hide(),this.input.show(),this.saveButton.attr("disabled",!1),this.cancelButton.attr("disabled",!1),this.focusTarget().focus(),this.onStartEditing()},showError:function(e){this.errorMessage.html(e),this.errorMessage.show()},focusTarget:function(){return this.input},val:function(e){return"need to override val(v) methos."},oldVal:function(){return this.oldValue},newVal:function(){return this.val()},toPlaceholder:function(t){if(t===null||t===undefined||t===""||e.isArray(t)&&t.length===0)return this.opts.placeholder},toLabel:function(e){return n(e)},addSaveEventListener:function(e){this.saveButton.bind("click",e),this.dom.find(".xfanIpeEnableKeyDownEvent").bind("keydown",function(t){t.which==13&&e()})},addCancelEventListener:function(e){this.cancelButton.bind("click",e),this.dom.find(".xfanIpeEnableKeyDownEvent").bind("keydown",function(t){t.which==27&&e()})},onStartEditing:function(){},onFinishEditing:function(){},onAppendToDocument:function(){}}),xfan.ipe.register("text",{val:function(e){return e===undefined?this.input.val():this.input.val(e)},createInput:function(){var t=e('<input type="text" />').addClass("xfanIpeEnableKeyDownEvent").addClass(this.opts.textFieldClass||"xfanIpeTextField");return this.opts.name&&t.attr("name",this.opts.name),t}}),xfan.ipe.register("textarea",{toLabel:function(e){return n(e).replace(/\n/g,"<br/>")},val:function(e){return e===undefined?this.input.val():this.input.val(e)},createInput:function(){var t=e("<textarea></textarea>").addClass(this.opts.textAreaClass||"xfanIpeTextArea");return this.opts.name&&t.attr("name",this.opts.name),this.opts.enableKeyDownEvent&&t.addClass("xfanIpeEnableKeyDownEvent"),t}}),xfan.ipe.register("radio",{toLabel:function(e){return this.opts.options[e]},val:function(t){if(!t)return this.input.find("input[type='radio']:checked").val();this.input.find("input[type='radio']").each(function(){if(t==e(this).val())return e(this).attr("checked","checked"),!1})},createInput:function(){var n=e("<span></span>").addClass(this.opts.radioGroupClass||"xfanIpeRadioGroup"),r=this;return e.each(this.opts.options,function(i,s){var o=e("<span></span>").addClass(r.opts.radioOptionClass||"xfanIpeRadioOption"),u=e(t('<input type="radio" id="xfanIpeRadioInput-#{n}-#{v}" name="#{n}" value="#{v}" />',{n:r.opts.name,v:i})).addClass(r.opts.radioInputClass||"xfanIpeRadioInput").addClass("xfanIpeEnableKeyDownEvent"),s=e(t('<label for="xfanIpeRadioInput-#{n}-#{v}">#{l}</label>',{n:r.opts.name,v:i,l:s})).addClass(r.opts.radioLabelClass||"xfanIpeRadioLabel");o.append(u).append(s).appendTo(n)}),n}}),xfan.ipe.register("select",{toLabel:function(e){return this.opts.options[e]},val:function(e){return e===undefined?this.input.val():this.input.val(e)},createInput:function(){var n=e(t('<select name="#{n}" />',{n:this.opts.name})).addClass(this.opts.selectClass||"xfanIpeSelect").addClass("xfanIpeEnableKeyDownEvent");this.opts.caption&&n.append(e(t('<option value="">#{l}</option>',{l:this.opts.caption})));var r=this;return e.each(this.opts.options,function(i,s){var o=e(t('<option value="#{v}">#{l}</option>',{v:i,l:s})).addClass(r.opts.selectOptionClass||"xfanIpeSelectOption");n.append(o)}),n}}),xfan.ipe.register("checkbox",{toLabel:function(e){var t="",n=this.opts.delim||", ";for(var r=0;r<e.length;r++)t+=this.opts.options[e[r]],r!=e.length-1&&(t+=n);return t},val:function(t){if(!t){var t=[];return this.input.find("input[type='checkbox']:checked").each(function(){t.push(e(this).val())}),t}var n=this;e.each(t,function(){var t=this;n.input.find("input[type='checkbox']").each(function(){if(t==e(this).val())return e(this).attr("checked","checked"),!1})})},createInput:function(){var n=e("<span></span>").addClass(this.opts.checkboxGroupClass||"xfanIpeCheckboxGroup"),r=this;return e.each(this.opts.options,function(i,s){var o=e("<span></span>").addClass(r.opts.checkboxOptionClass||"xfanIpeCheckboxOption").addClass("xfanIpeEnableKeyDownEvent"),u=e(t('<input type="checkbox" id="xfanIpeCheckboxInput-#{n}-#{v}" name="#{n}" value="#{v}" />',{n:r.opts.name,v:i})).addClass(r.opts.checkboxInputClass||"xfanIpeCheckboxInput"),s=e(t('<label for="xfanIpeCheckboxInput-#{n}-#{v}">#{l}</label>',{n:r.opts.name,v:i,l:s})).addClass(r.opts.checkboxLabelClass||"xfanIpeCheckboxLabel");o.append(u).append(s).appendTo(n)}),n}}),xfan.ipe.register("password",{init:function(){this.passwordValue={}},toLabel:function(e){return e.input&&e.input.length>0?"********":""},val:function(e){if(!e)return{input:this.passwordValue.input,confirm:this.passwordValue.confirm};this.passwordValue.input=e.input,this.passwordValue.confirm=e.confirm},onFinishEditing:function(){this.val({input:this.passwordInput.val(),confirm:this.passwordConfirm.val()}),this.passwordInput.val(""),this.passwordConfirm.val("")},createInput:function(){var n=e("<span></span>").addClass(this.opts.passwordClass||"xfanIpePassword"),r=e("<span></span>").addClass(this.opts.passwordInputLineClass||"xfanIpePasswordInputLine"),i=e("<span></span>").addClass(this.opts.passwordConfirmLineClass||"xfanIpePasswordConfirmLine");this.passwordInput=e('<input type="password" />').addClass(this.opts.passwordInputClass||"xfanIpePasswordInput").addClass("xfanIpeEnableKeyDownEvent").appendTo(r),this.passwordConfirm=e('<input type="password" />').addClass(this.opts.passwordConfirmClass||"xfanIpePasswordConfirm").addClass("xfanIpeEnableKeyDownEvent").appendTo(i);var s=e(t("<span>#{n}</span>",{n:this.opts.reenterMessage||"reenter"})).addClass(this.opts.passwordReenterMessageClass||"xfanIpePasswordReenterMessage").appendTo(i);return n.append(r).append(i),n}}),xfan.ipe.register("date",{init:function(){if(this.opts.yearDisabled&&this.opts.monthDisabled&&this.opts.dayDisabled)throw"at least one field (year|month|day) must be enabled";this.opts.yearName=this.opts.yearName||"year",this.opts.monthName=this.opts.monthName||"month",this.opts.dayName=this.opts.dayName||"day";if(!this.opts.format){var e=[];this.opts.yearDisabled||e.push("yyyy"),this.opts.monthDisabled||e.push("MM"),this.opts.dayDisabled||e.push("dd"),this.opts.format=e.join("/")}this.fmt=new DateFormat(this.opts.format)},toLabel:function(e){var t=this.opts.yearDisabled?1:e.year,n=this.opts.monthDisabled?0:e.month,r=this.opts.dayDisabled?1:e.day;return this.fmt.format(new Date(t,n,r))},val:function(t){if(!t)return e.extend({},this.opts.yearDisabled?{}:{year:parseInt(this.yearInput.val())},this.opts.monthDisabled?{}:{month:parseInt(this.monthInput.val())-1},this.opts.dayDisabled?{}:{day:parseInt(this.dayInput.val())});this.opts.yearDisabled||this.yearInput.val(t.year),this.opts.monthDisabled||this.monthInput.val(t.month+1),this.opts.dayDisabled||this.dayInput.val(t.day)},createInput:function(){var n=e("<span></span>").addClass(this.opts.dateClass||"xfanIpeDate");if(!this.opts.yearDisabled){this.yearInput=e(t('<select name="#{n}" />',{n:this.opts.yearName})).addClass(this.opts.dateYearClass||"xfanIpeDateYear").addClass("xfanIpeEnableKeyDownEvent");var r=this.opts.yearStart||(new Date).getFullYear()-100,i=this.opts.yearEnd||(new Date).getFullYear();for(var s=r;s<=i;s++)this.yearInput.append(e(t('<option value="#{v}">#{v}</option>',{v:s})));n.append(this.yearInput);if(this.opts.yearLabel){var o=e(t("<span>#{l}</span>",{l:this.opts.yearLabel})).addClass(this.opts.dateYearLabelClass||"xfanIpeDateYearLabel");n.append(o)}}if(!this.opts.monthDisabled){this.monthInput=e(t('<select name="#{n}" />',{n:this.opts.monthName})).addClass(this.opts.dateMonthClass||"xfanIpeDateMonth").addClass("xfanIpeEnableKeyDownEvent");for(var s=1;s<=12;s++)this.monthInput.append(e(t('<option value="#{v}">#{v}</option>',{v:s})));n.append(this.monthInput);if(this.opts.monthLabel){var o=e(t("<span>#{l}</span>",{l:this.opts.monthLabel})).addClass(this.opts.dateMonthLabelClass||"xfanIpeDateMonthLabel");n.append(o)}}if(!this.opts.dayDisabled){this.dayInput=e(t('<select name="#{n}" />',{n:this.opts.dayName})).addClass(this.opts.dateDayClass||"xfanIpeDateDay").addClass("xfanIpeEnableKeyDownEvent");for(var s=1;s<=31;s++)this.dayInput.append(e(t('<option value="#{v}">#{v}</option>',{v:s})));n.append(this.dayInput);if(this.opts.dayLabel){var o=e(t("<span>#{l}</span>",{l:this.opts.dayLabel})).addClass(this.opts.dateDayLabelClass||"xfanIpeDateDayLabel");n.append(o)}}return n}}),xfan.ipe.register("datepicker",{init:function(){this.opts.datepicker=this.opts.datepicker||{},this.opts.datepicker.dateFormat||(this.opts.datepicker.dateFormat="mm/dd/yy")},format:function(t){return t===null?"":e.datepicker.formatDate(this.opts.datepicker.dateFormat,new Date(t.year,t.month,t.day))},parse:function(t){var n=e.datepicker.parseDate(this.opts.datepicker.dateFormat,t);return n===null?null:{year:n.getFullYear(),month:n.getMonth(),day:n.getDate()}},toLabel:function(e){return this.format(e)},val:function(e){if(!e)return this.parse(this.dateInput.val());this.dateInput.val(this.format(e))},createInput:function(){return this.dateInput=e(t('<input type="text" size="#{s}" />',{s:this.opts.fieldSize||10})).addClass(this.opts.datepickerFieldClass||"xfanIpeDatepickerFieldClass"),this.opts.name&&this.dateInput.attr("name",this.opts.name),this.dateInput.datepicker(this.opts.datepicker),e("<span></span>").append(this.dateInput)}}),xfan.ipe.register("tinymce",{init:function(){this.content="",this.opts.tinymce=this.opts.tinymce||{}},savingMode:function(e){this.onFinishEditing(),this.saveButton.attr("disabled",!0),this.cancelButton.attr("disabled",!0),this.opts["tinymce"]["theme"]=="advanced"?tinyMCE.get(this.editorId).setProgressState(!0):(this.input.hide(),this.savingMessage.show()),e&&e()},editingMode:function(){this.errorMessage.hide(),this.savingMessage.hide(),this.opts["tinymce"]["theme"]=="advanced"?tinyMCE.get(this.editorId).setProgressState(!1):this.input.show(),this.saveButton.attr("disabled",!1),this.cancelButton.attr("disabled",!1),this.focusTarget().focus(),this.onStartEditing()},onFinishEditing:function(){this.content=tinyMCE.get(this.editorId).getContent()},onStartEditing:function(){tinyMCE.get(this.editorId).setContent(this.content)},val:function(e){if(!e)return this.content;this.content=e},createInput:function(){this.editorId=t("xfanIpeTinymceTextArea-#{n}",{n:this.opts.name});var n=e(t('<textarea id="#{id}" name="#{n}"></textarea>',{id:this.editorId,n:this.opts.name})),r={body_class:"xfanIpeTinymceBody"};return e.extend(r,this.opts.tinymce,{mode:"exact",elements:this.editorId}),e(window).bind("load",function(){tinyMCE.init(r)}),e("<span></span>").append(n)}}),e.fn.xfanIpe=function(t,n){return this.each(function(){var r=e.extend({},xfan.ipe.defaultOptions,n||{}),i=e(this),s=i.attr("id"),o=new xfan.ipe.Editable(s,r),u=new xfan.ipe.editors[r.formType](s,r),a=u.toPlaceholder(u.val())||u.toLabel(u.val());o.label(a),i.append(o.dom).append(u.dom),u.onAppendToDocument();var f=function(){u.savingMode();var n=u.oldVal(),i=u.newVal();n=JSON.stringify(n),i=JSON.stringify(i);if(n==i){u.passivate(function(){o.show("fast")});return}var s={oldValue:n,newValue:i};r.id&&e.extend(s,{id:r.id}),e.extend(s,r.data);if(r.beforeSave&&r.beforeSave(n,i)===!1){u.passivate(function(){o.show("fast")});return}e.ajax({url:t,type:"POST",dataType:"json",data:s,success:function(e){if(e.error){u.editingMode(),u.showError(e.message);return}u.passivate(function(){var t=JSON.parse(e.data);u.val(t);var n=u.toPlaceholder(t)||u.toLabel(t);o.label(n),o.show("fast",function(){r.onSaveComplete&&r.onSaveComplete(t,o,u)})})}})},l=function(){u.discard(function(){o.show("fast")})};u.addSaveEventListener(f),u.addCancelEventListener(l),o.addEditEventListener(r.editEvent,function(){o.hide("fast",function(){u.activate()})})}),e(this)}})(jQuery);